name: Update Formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version to update to (e.g., 0.2.0)'
        required: true
        type: string
      sha256_amd64_darwin:
        description: 'SHA256 for macOS Intel binary'
        required: true
        type: string
      sha256_arm64_darwin:
        description: 'SHA256 for macOS ARM binary'
        required: true
        type: string
      sha256_amd64_linux:
        description: 'SHA256 for Linux Intel binary'
        required: true
        type: string
      sha256_arm64_linux:
        description: 'SHA256 for Linux ARM binary'
        required: true
        type: string

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    - name: Install Homebrew
      run: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo "$HOME/.linuxbrew/bin" >> $GITHUB_PATH

    - name: Update formula
      run: |
        VERSION="${{ github.event.inputs.version }}"
        SHA256_AMD64_DARWIN="${{ github.event.inputs.sha256_amd64_darwin }}"
        SHA256_ARM64_DARWIN="${{ github.event.inputs.sha256_arm64_darwin }}"
        SHA256_AMD64_LINUX="${{ github.event.inputs.sha256_amd64_linux }}"
        SHA256_ARM64_LINUX="${{ github.event.inputs.sha256_arm64_linux }}"
        
        # Create updated formula content
        cat > Casks/gitsweeper.rb << 'EOF'
        # This file was generated by GoReleaser. DO NOT EDIT.
        cask "gitsweeper" do
          desc "A command-line tool for cleaning up merged Git branches"
          homepage "https://github.com/petems/gitsweeper"
          version "$VERSION"

          livecheck do
            skip "Auto-generated on release."
          end

          binary "gitsweeper"

          on_macos do
            on_intel do
              url "https://github.com/petems/gitsweeper/releases/download/v$VERSION/gitsweeper-$VERSION-darwin-amd64.tar.gz"
              sha256 "$SHA256_AMD64_DARWIN"
            end
            on_arm do
              url "https://github.com/petems/gitsweeper/releases/download/v$VERSION/gitsweeper-$VERSION-darwin-arm64.tar.gz"
              sha256 "$SHA256_ARM64_DARWIN"
            end
          end

          on_linux do
            on_intel do
              url "https://github.com/petems/gitsweeper/releases/download/v$VERSION/gitsweeper-$VERSION-linux-amd64.tar.gz"
              sha256 "$SHA256_AMD64_LINUX"
            end
            on_arm do
              url "https://github.com/petems/gitsweeper/releases/download/v$VERSION/gitsweeper-$VERSION-linux-arm64.tar.gz"
              sha256 "$SHA256_ARM64_LINUX"
            end
          end

          caveats do
            "gitsweeper is a tool for cleaning up merged Git branches."
            ""
            "To get started:"
            "  gitsweeper --help"
          end

          # No zap stanza required
        end
        EOF

    - name: Test updated formula
      run: |
        brew audit --strict --online Casks/gitsweeper.rb
        brew style Casks/gitsweeper.rb
        brew install --dry-run Casks/gitsweeper.rb

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Casks/gitsweeper.rb
        git commit -m "Update gitsweeper to version ${{ github.event.inputs.version }}"
        git push 